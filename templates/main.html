<!DOCTYPE html>
{% load static%}
{% load pwa %}

<style>
/* Ocultar elementos cuando está en modo PWA */
.pwa-mode body {
    overflow: hidden; /* Evita scroll no deseado */
    height: 100vh;   /* Ocupa toda la pantalla */
}

/* Ocultar la barra de direcciones en iOS */
@supports (-webkit-touch-callout: none) {
    .pwa-mode {
        -webkit-touch-callout: none;
    }
}

</style>

<html lang="en">

<head>
    <link rel="manifest" href="{% url 'manifest' %}" crossorigin="use-credentials">

    {% progressive_web_app_meta %}
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Para Android/Chrome -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Para iOS/Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" />
    <link rel="shortcut icon" href="{% static 'images/olympia_logo.png' %}" type="image/x-icon" />
    <link rel="stylesheet" href="{% static 'styles/style.css' %}" />
    <title>CFF Olympia</title>
</head>

<body>

    {% include 'navbar.html' %}

    {% block content %}
    
    
    {% endblock %}


    <script src="{% static 'js/script.js' %}"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                // Ruta correcta usando la etiqueta static de Django
                navigator.serviceWorker.register('{% static "js/sw.js" %}')
                    .then(function (registration) {
                        console.log('ServiceWorker registrado con éxito:', registration.scope);

                        // Verificar actualizaciones periódicamente
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000); // Cada hora
                    })
                    .catch(function (error) {
                        console.log('Error al registrar el ServiceWorker:', error);
                    });
            });

            // Forzar actualización al cargar la página
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                registrations.forEach(function (registration) {
                    registration.update();
                });
            });
        }
    </script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const burger = document.querySelector('.header__burger');
        const menu = document.querySelector('.header__menu');

        burger.addEventListener('click', function () {
            menu.classList.toggle('header__menu--open');
        });
    });
</script>

<script>
    // Unregister existing service workers
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
                registration.unregister();
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => caches.delete(cacheName));
                });
            });
        });
    }
</script>

<script>
    // Versión optimizada del detector PWA + redirección
    document.addEventListener('DOMContentLoaded', function () {
        const isPwaInstalled = (
            window.matchMedia('(display-mode: standalone)').matches ||
            window.navigator.standalone === true
        );

        if (isPwaInstalled) {
            document.documentElement.classList.add('pwa-mode');
        } else {
            // Evita bucles de redirección en la página /download
            if (window.location.pathname !== '/download/') {
                // Redirige con retraso para mejor UX
                setTimeout(() => {
                    window.location.href = "/download/";
                }, 500);
            }
        }
    });
</script>
</body>

</html>













