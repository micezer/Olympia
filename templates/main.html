<!doctype html>
{% load static %} {% load pwa %}
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Para Android/Chrome -->
    <meta name="mobile-web-app-capable" content="yes" />
    <!-- Para iOS/Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

      <link rel="stylesheet" href="{% static 'css/main.css' %}">


    <link
      rel="manifest"
      href="{% url 'manifest' %}"
      crossorigin="use-credentials"
    />
    {% progressive_web_app_meta %}

    <link
      rel="shortcut icon"
      href="{% static 'images/olympia_logo.png' %}"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{% static 'styles/style.css' %}" />

      {% block extra_css %}
          {% endblock %}

    <title>CFF Olympia</title>

    <style>
      :root {
        --nav-h: 70px;
        --primary-blue: #2a374c;
      }

      body {
        margin: 0;
      }

      main {
        margin-top: var(--nav-h);
      }

      /* PWA fix */
      .pwa-mode {
        overflow: hidden !important;
        height: 100vh !important;
        position: fixed;
        width: 100%;
      }

      @supports (-webkit-touch-callout: none) {
        .pwa-mode {
          -webkit-touch-callout: none;
          height: -webkit-fill-available;
          padding-top: env(safe-area-inset-top);
        }
      }

      /* OVERLAY DE TRANSICIÓN - SOLO AÑADIDO */
      .page-transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--primary-blue);
        z-index: 999999;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.4s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .page-transition-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .page-transition-overlay img {
        width: 120px;
        opacity: 0;
        transform: scale(0.9);
        transition: all 0.4s ease 0.1s;
      }

      .page-transition-overlay.active img {
        opacity: 1;
        transform: scale(1);
      }
    </style>
  </head>

  <body>
    <!-- OVERLAY AÑADIDO - LO PRIMERO EN EL BODY -->
    <div class="page-transition-overlay" id="transitionOverlay">
      <img src="{% static 'images/olympia_logo.png' %}" alt="Olympia">
    </div>

    <!-- SCRIPT INMEDIATO - SOLO ACTIVA OVERLAY -->
    <script>
      (function() {
        // Activar overlay inmediatamente
        const overlay = document.getElementById('transitionOverlay');
        if (overlay) {
          overlay.classList.add('active');
        }
        
        // Marcar que es primera carga (para quitarlo después)
        sessionStorage.setItem('firstLoad', 'true');
      })();
    </script>

    {% include 'navbar.html' %}
    
    <div class="main-content">
      {% block content %}
      {% endblock %}
    </div>
  </body>

  <script src="{% static 'js/script.js' %}"></script>
  <script>
    // Script unificado para manejo PWA (TU CÓDIGO ORIGINAL SIN TOCAR)
    document.addEventListener("DOMContentLoaded", function () {
      // Detección del modo PWA
      const isPwaInstalled =
        window.matchMedia("(display-mode: standalone)").matches ||
        window.navigator.standalone === true;

      // Aplicar clase pwa-mode si está instalada
      if (isPwaInstalled) {
        document.documentElement.classList.add("pwa-mode");

        // Forzar actualización del service worker
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.getRegistrations().then((registrations) => {
            registrations.forEach((registration) => {
              registration.update();
            });
          });
        }
      }
      // Redirección para navegador normal (TU LÓGICA INTACTA)
      else if (window.location.pathname !== "/download/") {
        setTimeout(() => {
          window.location.href =
            "/download/?source=" + encodeURIComponent(window.location.pathname);
        }, 300);
      }

      // Registrar Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register('{% static "js/sw.js" %}?v=2')
          .then((registration) => {
            console.log(
              "ServiceWorker registrado con éxito:",
              registration.scope,
            );
          })
          .catch((error) => {
            console.log("Error al registrar ServiceWorker:", error);
          });
      }

      // Burger menu
      const burger = document.querySelector(".header__burger");
      const menu = document.querySelector(".header__menu");
      if (burger && menu) {
        burger.addEventListener("click", function () {
          menu.classList.toggle("header__menu--open");
        });
      }

      // AÑADIDO: Quitar overlay cuando todo esté listo (sin afectar tu lógica)
      const overlay = document.getElementById('transitionOverlay');
      const isFirstLoad = sessionStorage.getItem('firstLoad') === 'true';
      
      if (isFirstLoad && overlay) {
        window.addEventListener('load', function() {
          setTimeout(() => {
            overlay.classList.remove('active');
            sessionStorage.removeItem('firstLoad');
          }, 500);
        });
        
        // Fallback
        setTimeout(() => {
          if (overlay.classList.contains('active')) {
            overlay.classList.remove('active');
            sessionStorage.removeItem('firstLoad');
          }
        }, 3000);
      }
    });
  </script>

  {% block extra_js %}
  {% endblock %}
</html>